---
title: "Harvest_and_Model_Analyses"
author: "Wendel Raymond"
date: "August 19, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Code for Ecosphere "Location specific factors influence patterns and effects of subsistence sea otter harvest in Southeast Alaska"
Wendel W. Raymond, M. Tim Tinker, Michelle L. Kissling, Brad Benter, Verena A. Gill, Ginny L. Eckert
wraymond2@alaska.edu

# Sea otter harvest and model output analyses
Analyses for spatial and temporal patterns in the raw sea otter havest data. Also analyses of sea otter population simulation model.

```{r libraries}
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(nlme)
library(MASS)

theme_set(theme_classic())
```

## Data
Harvest data that has been cleaned up and model output data. Also results from Tinker et al 2019 10.1002/jwmg.21685.

### Harvest
Harvest and hunter datadata can be obtained from USFWS Marking Tagging and Reporting Program. 
```{r data-harvest}
harv <- read.csv()
```

### Other sea otter data
```{r data-other}
# Tim's model all SEAK - see Tinker et al 2019 10.1002/jwmg.21685 #
survey.mod <- read.csv("All_Data/Tinker_survey_model_AllSEAK_revmod.csv")

# Tim's model with regional breakdowns see Tinker et al 2019 10.1002/jwmg.21685 #
survey.mod.reg <- read.csv("All_Data/Tinker_survey_model_AllRegions_revmod.csv")

# Subpopulation occupation data #
BlokOcc <- read.csv("All_data/BlokOcc.csv", header = TRUE)

# Cummulative harvest occupation and % native #
cumharv <- read.csv("All_data/Cummulative_harv_duration_native.csv", header = TRUE, stringsAsFactors = FALSE)

# Hunter harvest data
hunt <- read.csv()
hunt$Hunter_Name <- as.character(hunt$Hunter_Name)

# Hunter subreg
hunt.subreg <- read.csv("All_data/Hunter_village_subregions.csv", header = TRUE, stringsAsFactors = FALSE)

# Block data #
block.data <- read.csv("All_data/Blockdata_new.csv", header = TRUE)

# Census Data #
cens <- read.csv("All_Data/census_hunting_comm_est.csv", header = TRUE, stringsAsFactors = FALSE)

# Inverse Distance #
inv.dist <- read.csv("All_Data/Inverse_distances.csv", header = TRUE, stringsAsFactors = FALSE)
```

### Model output - Means
From Sea_otter_simulation_model.Rmd
```{r data-model out}
## Southeast Total ##
SE.harv <- read.csv("Model_Output/output_harv_FriFeb08_2019_SEAK.csv", header = TRUE)
SE.noharv <- read.csv("Model_Output/output_noharv_FriFeb08_2019_SEAK.csv", header = TRUE)

## Sitka Sound ##
SS.harv <- read.csv("Model_Output/output_harv_FriFeb08_2019_Sitka.csv", header = TRUE)
SS.noharv <- read.csv("Model_Output/output_noharv_FriFeb08_2019_Sitka.csv", header = TRUE)

## Keku Strait ##
KS.harv <- read.csv("Model_Output/output_harv_FriFeb08_2019_Keku.csv", header = TRUE)
KS.noharv <- read.csv("Model_Output/output_noharv_FriFeb08_2019_Keku.csv", header = TRUE)

## Maurelle Islands ##
MI.harv <- read.csv("Model_Output/output_harv_FriFeb08_2019_Maurelle.csv", header = TRUE)
MI.noharv <- read.csv("Model_Output/output_noharv_FriFeb08_2019_Maurelle.csv", header = TRUE)

## All Blocks ##
ALL.harv <- read.csv("Model_Output/output_harv_FriFeb08_2019_HabBlks.csv", header = TRUE)
ALL.noharv <- read.csv("Model_Output/output_noharv_FriFeb08_2019_HabBlks.csv", header = TRUE)
```

### Model output - RepSums
```{r data-model repsums}
## no harvest data ##
RepSums_SEAK_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_SEAK.csv", header = TRUE)
RepSums_Sitka_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_Sitka.csv", header = TRUE)
RepSums_Keku_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_Keku.csv", header = TRUE)
RepSums_Barrier_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_Barrier.csv", header = TRUE)
RepSums_Maurelle_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_Maurelle.csv", header = TRUE)
RepSums_Bucareli_noharv <- read.csv("Model_Output/repsums_noharv_FriFeb08_2019_Bucareli.csv", header = TRUE)

## with harvest data ##
RepSums_SEAK_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_SEAK.csv", header = TRUE)
RepSums_Sitka_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_Sitka.csv", header = TRUE)
RepSums_Keku_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_Keku.csv", header = TRUE)
RepSums_Barrier_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_Barrier.csv", header = TRUE)
RepSums_Maurelle_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_Maurelle.csv", header = TRUE)
RepSums_Bucareli_harv <- read.csv("Model_Output/repsums_harv_FriFeb08_2019_Bucareli.csv", header = TRUE)
```

## Harvest summaries
### All SEAK
```{r all seak}
## Build data frame with harvest and model data ##
# Model data #
year.tbl <- survey.mod[,c(1:4)]
colnames(year.tbl)<- c("Year", "Population", "Pop_LO", "Pop_HI")
year.tbl <- rbind(year.tbl, c(2013, NA, NA, NA))
year.tbl <- rbind(year.tbl, c(2014, NA, NA, NA))
year.tbl <- rbind(year.tbl, c(2015, NA, NA, NA))

# Harvest data #
year.tbl.dat <- as.data.frame(
  harv %>%
    group_by(Year) %>%
    summarise(Harvest=n())
)

# Merge together and calculate #
year.tbl <- merge(year.tbl, year.tbl.dat, by = "Year", all.x = TRUE)
year.tbl$rate <- (year.tbl$Harvest / (year.tbl$Harvest + year.tbl$Population))
year.tbl$rate_lo <- (year.tbl$Harvest / (year.tbl$Harvest + year.tbl$Pop_HI))
year.tbl$rate_hi <- (year.tbl$Harvest / (year.tbl$Harvest + year.tbl$Pop_LO))
```

### Sitka Sound
```{r sitka sound}
## Build data frame with harvest and model data ##
# Model data #
SS.survey <- data.frame(
  survey.mod.reg %>% 
    filter(Subregion == "N05")
)

Sitkayear.tbl <- SS.survey[,c(3,7,4,6)]
colnames(Sitkayear.tbl)<- c("Year", "Population", "Pop_LO", "Pop_HI")
Sitkayear.tbl <- rbind(Sitkayear.tbl, c(2013, NA, NA, NA))
Sitkayear.tbl <- rbind(Sitkayear.tbl, c(2014, NA, NA, NA))
Sitkayear.tbl <- rbind(Sitkayear.tbl, c(2015, NA, NA, NA))

# Harvest data #
Sitkayear.tbl.dat <- data.frame(
  harv %>% 
    filter(Subpop == "N05") %>% 
    group_by(Year) %>% 
    summarise(Harvest = n())
)

# Merge together and calculate #
Sitkayear.tbl <- merge(Sitkayear.tbl, Sitkayear.tbl.dat, by = "Year", all.x  = TRUE)
Sitkayear.tbl[14, 5:6] <- 0
Sitkayear.tbl$rate <- (Sitkayear.tbl$Harvest / (Sitkayear.tbl$Harvest + Sitkayear.tbl$Population))
Sitkayear.tbl$rate_lo <- (Sitkayear.tbl$Harvest / (Sitkayear.tbl$Harvest + Sitkayear.tbl$Pop_HI))
Sitkayear.tbl$rate_hi <- (Sitkayear.tbl$Harvest / (Sitkayear.tbl$Harvest + Sitkayear.tbl$Pop_LO))

# Calculate annual density #
Sitkayear.tbl$pop_dens <- (Sitkayear.tbl$Population / block.data$Area_km[block.data$Subpop == "N05"])
```

### Keku Strait
```{r keku strait}
## Build data frame with harvest and model data ##
# Model data #
KS.survey <- data.frame(
  survey.mod.reg %>% 
    filter(Subregion == "S08")
)

Kekuyear.tbl <- KS.survey[,c(3,7,4,6)]
colnames(Kekuyear.tbl)<- c("Year", "Population", "Pop_LO", "Pop_HI")
Kekuyear.tbl <- rbind(Kekuyear.tbl, c(2013, NA, NA, NA))
Kekuyear.tbl <- rbind(Kekuyear.tbl, c(2014, NA, NA, NA))
Kekuyear.tbl <- rbind(Kekuyear.tbl, c(2015, NA, NA, NA))

# Harvest data #
Kekuyear.tbl.dat <- as.data.frame(
  harv %>%
    filter(Subpop == "S08") %>% 
    group_by(Year) %>%
    summarise(Harvest=n())
)

# Merge together and calculate #
Kekuyear.tbl <- merge(Kekuyear.tbl, Kekuyear.tbl.dat, by = "Year", all.x = TRUE)
Kekuyear.tbl$Harvest[is.na(Kekuyear.tbl$Harvest)] <- 0
Kekuyear.tbl$rate <- (Kekuyear.tbl$Harvest / (Kekuyear.tbl$Harvest + Kekuyear.tbl$Population))
Kekuyear.tbl$rate_lo <- (Kekuyear.tbl$Harvest / (Kekuyear.tbl$Harvest + Kekuyear.tbl$Pop_HI))
Kekuyear.tbl$rate_hi <- (Kekuyear.tbl$Harvest / (Kekuyear.tbl$Harvest + Kekuyear.tbl$Pop_LO))

# Calculate annual density #
Kekuyear.tbl$pop_dens <- (Kekuyear.tbl$Population / block.data$Area_km[block.data$Subpop == "S08"])
```

### Maurelle Islands
```{r maurelle}
## Build data frame with harvest and model data ##
# Model data #
MI.survey <- data.frame(
  survey.mod.reg %>% 
    filter(Subregion == "S02")
)

Mauryear.tbl <- MI.survey[,c(3,7,4,6)]
colnames(Mauryear.tbl)<- c("Year", "Population", "Pop_LO", "Pop_HI")
Mauryear.tbl <- rbind(Mauryear.tbl, c(2013, NA, NA, NA))
Mauryear.tbl <- rbind(Mauryear.tbl, c(2014, NA, NA, NA))
Mauryear.tbl <- rbind(Mauryear.tbl, c(2015, NA, NA, NA))

# Harvest data #
Mauryear.tbl.dat <- as.data.frame(
  harv %>%
    filter(Subpop == "S02") %>% 
    group_by(Year) %>%
    summarise(Harvest=n())
)

# Merge together and calculate #
Mauryear.tbl <- merge(Mauryear.tbl, Mauryear.tbl.dat, by = "Year", all.x = TRUE)
Mauryear.tbl$Harvest[is.na(Mauryear.tbl$Harvest)] <- 0
Mauryear.tbl$rate <- (Mauryear.tbl$Harvest / (Mauryear.tbl$Harvest + Mauryear.tbl$Population))
Mauryear.tbl$rate_lo <- (Mauryear.tbl$Harvest / (Mauryear.tbl$Harvest + Mauryear.tbl$Pop_HI))
Mauryear.tbl$rate_hi <- (Mauryear.tbl$Harvest / (Mauryear.tbl$Harvest + Mauryear.tbl$Pop_LO))

Mauryear.tbl[1:13, 5:8] <- NA

# Calculate annual density #
Mauryear.tbl$pop_dens <- (Mauryear.tbl$Population / block.data$Area_km[block.data$Subpop == "S02"])
```

### Proportion of region to total harvest
```{r proportion}
## Build proportion data frame ##
regprop.tbl <- data.frame(cbind(year.tbl$Year, year.tbl$Harvest, Sitkayear.tbl$Harvest, Kekuyear.tbl$Harvest, Mauryear.tbl$Harvest))
colnames(regprop.tbl) <- c("Year", "SEAK", "Sitka", "Keku", "Maur")
regprop.tbl$pSitka <- regprop.tbl$Sitka/regprop.tbl$SEAK
regprop.tbl$pKeku <- regprop.tbl$Keku/regprop.tbl$SEAK
regprop.tbl$pMaur <- regprop.tbl$Maur/regprop.tbl$SEAK
```

## Sea otter harvest by year plots
Plots of sea otter harvest and harvest rate
```{r year plots}
## All SEAK n harvest ##
AH <- ggplot(year.tbl) +
  geom_line(aes(Year, Harvest), size = 0.5, color = "black") +
  labs(x = "", y = "Sea otters harvest") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0,1500)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))


## All SEAK annual harevst rate ##
AR <- ggplot(year.tbl) +
  geom_line(aes(Year, rate), size = 0.5, color = "black") +
  geom_ribbon(aes(Year, ymin = rate_lo, ymax = rate_hi), fill = "black", alpha = 0.2) +
  scale_x_continuous(limits = c(1988, 2015),breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0.0, 0.2)) +
  labs(x = "Year", y = "Harvest rate (+/- 95% CI)") +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka n harvest ##
SH <- ggplot(Sitkayear.tbl) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0, 500)) +
  geom_line(aes(Year, Harvest), color = "black") +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12, color = "black"), axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka annual harvest rate ##
SR <- ggplot(Sitkayear.tbl) +
  geom_line(aes(Year, rate), size = 0.5, color = "black") +
  geom_ribbon(aes(Year, ymin = rate_lo, ymax = rate_hi), fill = "black", alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0.0, 1)) +
  labs(x = "Year", y = "") +
  theme(text = element_text(size = 12, color = "black"), axis.text.x = element_text(angle = 45, hjust = 1))

## Keku n harvest ##
KH <- ggplot(Kekuyear.tbl) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0, 300)) +
  geom_line(aes(Year, Harvest), color = "black") +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Keku annual harvest rate ##
KR <- ggplot(Kekuyear.tbl) +
  geom_line(aes(Year, rate), size = 0.5, color = "black") +
  geom_ribbon(aes(Year, ymin = rate_lo, ymax = rate_hi), fill = "black", alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0.0, 1.0)) +
  labs(x = "Year", y = "") +
  theme(text = element_text(size = 12, color = "black"), axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle n harvest ##
MH <- ggplot(Mauryear.tbl) +
  geom_line(aes(Year, Harvest), color = "black") +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0, 200)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle annual harvest rate ##
MR <- ggplot(Mauryear.tbl) +
  geom_line(aes(Year, rate), color = "black") +
  geom_ribbon(aes(Year, ymin = rate_lo, ymax = rate_hi), fill = "black", alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  ylim(c(0.0, 0.2)) +
  labs(x = "Year", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))
```

## Sea otter population plots
Only plotting survey popualtio trends during the time of harvest.
```{r pop plots}
## Southeast Alaska ##
AS <- ggplot() +
  geom_line(data = survey.mod, aes(Year, N)) +
  geom_ribbon(data = survey.mod, aes(Year, ymin = N_LO, ymax = N_HI), alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  scale_y_continuous(limits = c(0,40000), breaks = c(0, 10000, 20000, 30000, 40000)) +
  labs(x = "", y = "Sea otters (+/- 95% CI)") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka Sound ##
SS <- ggplot() +
  geom_line(data = SS.survey, aes(Year, Mean)) +
  geom_ribbon(data = SS.survey, aes(Year, ymin = Lower95, ymax = Upper95), alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  scale_y_continuous(limits = c(0,1200), breaks = c(0, 300, 600, 900, 1200)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Keku Strait ##
KS <- ggplot() +
  geom_line(data = KS.survey, aes(Year, Mean)) +
  geom_ribbon(data = KS.survey, aes(Year, ymin = Lower95, ymax = Upper95), alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  scale_y_continuous(limits = c(0,1200), breaks = c(0, 300, 600, 900, 1200)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle Islands ##
MS <- ggplot() +
  geom_line(data = MI.survey, aes(Year, Mean)) +
  geom_ribbon(data = MI.survey, aes(Year, ymin = Lower95, ymax = Upper95), alpha = 0.3) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015), limits = c(1988, 2015)) +
  scale_y_continuous(limits = c(0, 7500), breaks = c(0, 1500, 3000, 4500, 6000, 7500)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))
```

## Hunter data
Summarise number of unique hunters in each community in each year. For multiple regression, sum 
```{r hunter}
## Examine unknown hunters ##
hunt.unk <- hunt %>% 
  filter(Hunter_Name == "Unknown")

## master hunters by year by village ##
hunter.loc.year.tbl <- data.frame(
  hunt %>%
    filter(Hunter_Name != "Unknown") %>% 
    group_by(Year, Village) %>% 
    summarise(n_hunter = length(unique(Hunter_Name)))
)

## master hunters by village ##
hunter.loc.cum <- data.frame(
  hunt %>% 
    group_by(Village) %>% 
    summarise(n_hunter = length(unique(Hunter_Name)))
)

## SEAK hunters ##
hunter.SEAK.year.tbl <- data.frame(
  hunter.loc.year.tbl %>% 
    group_by(Year) %>% 
    summarise(Village = "SEAK",
      n_hunter = sum(n_hunter))
)

hunter.SEAK.year.tbl$Village <- "SEAK"

## Regional hunters ##
hunter.loc.year.tbl$Village <- as.factor(hunter.loc.year.tbl$Village)
levels(hunter.loc.year.tbl$Village)[levels(hunter.loc.year.tbl$Village)=="Naukati Bay"] <- "Maurelle"
levels(hunter.loc.year.tbl$Village)[levels(hunter.loc.year.tbl$Village)=="Craig"] <- "Maurelle"
levels(hunter.loc.year.tbl$Village)[levels(hunter.loc.year.tbl$Village)=="Klawock"] <- "Maurelle"

hunter.subreg.year.tbl <- data.frame(
  hunter.loc.year.tbl %>%
    filter(Village == "Sitka" | Village == "Kake" | Village == "Maurelle") %>% 
    group_by(Year, Village) %>% 
    summarise(n_hunter = sum(n_hunter))
)

## Combine ##
hunter.allreg.tbl <- rbind(hunter.SEAK.year.tbl, hunter.subreg.year.tbl)

## Summary stats ##
hunter.stats <- hunter.allreg.tbl %>% 
  group_by(Village) %>% 
  summarise(hunt_mean = mean(n_hunter),
            hunt_sd = sd(n_hunter))
```

### Plotting hunters
```{r hunter plot}
ggplot(hunter.allreg.tbl) +
  geom_bar(aes(x = Year, y = n_hunter, fill = Village), position = "dodge", stat = "identity")

AHt <- ggplot(subset(hunter.allreg.tbl, Village == "SEAK")) +
  geom_line(aes(Year, n_hunter), size = 0.5, color = "black") +
  labs(x = "Year", y = "Hunters") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0,120)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

SHt <- ggplot(subset(hunter.allreg.tbl, Village == "Sitka")) +
  geom_line(aes(Year, n_hunter), size = 0.5, color = "black") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0,40)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

KHt <- ggplot(subset(hunter.allreg.tbl, Village == "Kake")) +
  geom_line(aes(Year, n_hunter), size = 0.5, color = "black") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0,40)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

MHt <- ggplot(subset(hunter.allreg.tbl, Village == "Maurelle")) +
  geom_line(aes(Year, n_hunter), size = 0.5, color = "black") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylim(c(0,40)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
```

## Harvested age/sex breakdowns
```{r harv age/sex}
## All Southeast Age/Sex Class ## 
# Create Age.Sex combine #
harv$Age.Class <- as.character(harv$Age.Class)
harv$Age.Class[harv$Age.Class == "S"] <- "J"
harv$Age.Class[harv$Age.Class == "P"] <- "J"
harv$Age.Sex <- paste(harv$Age.Class, harv$Sex, sep = "")
harv$Age.Sex[harv$Age.Sex == "AU"] <- "U"
harv$Age.Sex[harv$Age.Sex == "JU"] <- "U"
harv$Age.Sex[harv$Age.Sex == "UM"] <- "U"
harv$Age.Sex[harv$Age.Sex == "UF"] <- "U"
harv$Age.Sex[harv$Age.Sex == "UU"] <- "U"
harv$Age.Sex[harv$Age.Sex == "M"] <- "U"
harv$Age.Sex[harv$Age.Sex == "A"] <- "U"

## Build summaries ##
# All Southeast #
yearagesex.tbl <- data.frame(
  harv %>% 
    group_by(Year, Age.Sex) %>% 
    summarise(N = n()) %>% 
    mutate(freq = N / sum(N))
)

# Caclulate year over year mean fq #
meansagesex.tbl <- data.frame (
  yearagesex.tbl %>% 
    group_by(Age.Sex) %>% 
    summarise(mean = round(mean(freq), 3),
              sd = round(sd(freq), 3))
)

# Total adults and adult males #
adults <- filter(yearagesex.tbl, Age.Sex == "AF" | Age.Sex == "AM")
sum(adults$N)/nrow(harv)

# Males
sum(adults$N[adults$Age.Sex == "AM"])/sum(adults$N)

# Females
sum(adults$N[adults$Age.Sex == "AF"])/sum(adults$N)

# Total juveniles ##
juvs <- filter(yearagesex.tbl, Age.Sex == "JF" | Age.Sex == "JM")
sum(juvs$N)/nrow(harv)

# Males
sum(juvs$N[juvs$Age.Sex == "JM"])/sum(juvs$N)

# Females
sum(juvs$N[juvs$Age.Sex == "JF"])/sum(juvs$N)

# Unreported #
uns <- filter(yearagesex.tbl, Age.Sex == "U")
sum(uns$N)/nrow(harv)

# Sitka Sound #
Sitkayearagesex.tbl <- data.frame(
  harv %>% 
    filter(Subpop == "N05") %>% 
    group_by(Year, Age.Sex) %>% 
    summarise(N = n()) %>% 
    mutate(freq = N / sum(N))
)

# Caclulate year over year mean fq #
Sitkameansagesex.tbl <- data.frame (
  Sitkayearagesex.tbl %>% 
    group_by(Age.Sex) %>% 
    summarise(mean = round(mean(freq), 3),
              sd = round(sd(freq), 3))
)

# Keku Strait #
Kekuyearagesex.tbl <- as.data.frame(
  harv %>%
    filter(Subpop == "S08") %>% 
    group_by(Year, Age.Sex) %>%
    summarise(N = n()) %>% 
    mutate(freq = N / sum(N))
)

Kekumeansagesex.tbl <- data.frame (
  Kekuyearagesex.tbl %>% 
    group_by(Age.Sex) %>% 
    summarise(mean = round(mean(freq), 3),
              sd = round(sd(freq), 3))
)

# Maurelle Islands #
Mauryearagesex.tbl <- as.data.frame(
  harv %>%
    filter(Subpop == "S02") %>% 
    group_by(Year, Age.Sex) %>%
    summarise(N =n()) %>% 
    mutate(freq = N / sum(N))
)

Maurmeansagesex.tbl <- data.frame (
  Mauryearagesex.tbl %>% 
    group_by(Age.Sex) %>% 
    summarise(mean = round(mean(freq), 3),
              sd = round(sd(freq), 3))
)

```

## Harvested age/sex plots
```{r harv age/sex plots}
## Set colors ##
pal <- c("#663300", "#000000", "#996600", "#999999", "#0099FF")
pal.bw <- c("#000000", "#545454", "#666666", "#999999", "#CCCCCC")

## SEAK ##
AAS <- ggplot() +
  geom_bar(data = yearagesex.tbl, aes(x = Year, y = freq, fill = Age.Sex), stat = "identity") +
  scale_fill_manual(values = pal, name = "Age-sex class", labels = c("Adult female", "Adult male", "Juvenile female", "Juvenile male", "Unidentified")) +
  ylab("Proportion harvested sea otters") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  theme(text = element_text(size = 12)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka ##
SAS <- ggplot() +
  geom_bar(data = Sitkayearagesex.tbl, aes(x = Year, y = freq, fill = Age.Sex), stat = "identity") +
  scale_fill_manual(values = pal) +
  ylab("") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  theme(text = element_text(size = 12), legend.position = "none",axis.text.x = element_text(angle = 45, hjust = 1))

## Keku Strait ##
KAS <- ggplot() +
  geom_bar(data = Kekuyearagesex.tbl, aes(x = Year, y = freq, fill = Age.Sex), stat = "identity") +
  scale_fill_manual(values = pal) +
  ylab("") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  theme(text = element_text(size = 12), legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle Islands ##
MAS <- ggplot() +
  geom_bar(data = Mauryearagesex.tbl, aes(x = Year, y = freq, fill = Age.Sex), stat = "identity") +
  scale_fill_manual(values = pal) +
  ylab("") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

## SI - Age sex panel
Supplementray figure of age/sex of harvest
```{r}
legd <- get_legend(BAS)
theme_set(theme_cowplot(font_size = 12))
plot_grid(AAS, SAS, KAS, MAS, legd, nrow = 1, ncol = 5, labels = c("a", "b", "c", "d", ""))
```

## Panel 1
Panel figure of harvest, harvest rate, and age/sex by year
```{r panel 1}
theme_set(theme_cowplot(font_size = 10))
xoff <- .3 # relative x position of label, within one plot
yoff <- .93 # relative y position of label, within one plot
plot_grid(AS, SS, KS, MS, AH, SH, KH, MH, AR, SR, KR, MR, nrow = 3, ncol = 4, align = "v") +
  draw_plot_label(label = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l"), x = rep((xoff + 0:3) / 4, 3), y = 1-(1-yoff+rep(0:2, each = 4))/3, hjust = .5, vjust = .5, size = 10)
```

## Comparison of model output
Plots of model output with and without including sea otter harvest and comparisons to Tim's Bayesian model output

### Combine model output dataframes
```{r comb model output}
## SE Combine data ##
SE.runs <- merge(SE.harv[,2:5], SE.noharv[,2:5], by = "Year")
SE.runs <- merge(SE.runs, year.tbl[, c(1, 5)], all.x = TRUE)
colnames(SE.runs) <- c("Year", "Mean_harv", "low_harv", "high_harv", "Mean_noharv", "low_noharv", "high_noharv", "Harvest")

## SE Calculate harvest rate in simulation ##
SE.runs$Harvest_rate_sim <- (SE.runs$Harvest / (SE.runs$Harvest + SE.runs$Mean_harv)) 
SE.runs$high_Harvest_rate_sim <- (SE.runs$Harvest / (SE.runs$Harvest + SE.runs$low_harv))
SE.runs$low_Harvest_rate_sim <- (SE.runs$Harvest / (SE.runs$Harvest + SE.runs$high_harv))

## SE nnnual growth rate in simulation ##
SE.runs <-  mutate(SE.runs, mod_rate_mean = (Mean_harv - lag(Mean_harv))/lag(Mean_harv),
                   mod_rate_low = (low_harv - lag(low_harv))/lag(low_harv),
                   mod_rate_high = (high_harv - lag(high_harv))/lag(high_harv))

## SS calculate harvest rate in simulation ##
SS.harv <- merge(SS.harv, Sitkayear.tbl[, c(1, 5)], all.x = TRUE)
SS.harv$Harvest_rate_sim <- (SS.harv$Harvest / (SS.harv$Harvest + SS.harv$Mean))
SS.harv$high_Harvest_rate_sim <- (SS.harv$Harvest / (SS.harv$Harvest + SS.harv$lower))
SS.harv$low_Harvest_rate_sim <- (SS.harv$Harvest / (SS.harv$Harvest + SS.harv$upper))

## SS annual growth rate in simulation ##
SS.harv <- mutate(SS.harv, mod_rate_mean = (Mean - lag(Mean))/lag(Mean),
                   mod_rate_low = (lower - lag(lower))/lag(lower),
                   mod_rate_high = (upper - lag(upper))/lag(upper))

## KS calculate harvest rate in simulation ##
KS.harv <- merge(KS.harv, Kekuyear.tbl[, c(1, 5)], all.x = TRUE)
KS.harv$Harvest_rate_sim <- (KS.harv$Harvest / (KS.harv$Harvest + KS.harv$Mean))
KS.harv$high_Harvest_rate_sim <- (KS.harv$Harvest / (KS.harv$Harvest + KS.harv$lower))
KS.harv$low_Harvest_rate_sim <- (KS.harv$Harvest / (KS.harv$Harvest + KS.harv$upper))
KS.harv[37, 8] <- 0

## KS annal growth rate in simulation ##
KS.harv <- mutate(KS.harv, mod_rate_mean = (Mean - lag(Mean))/lag(Mean),
                   mod_rate_low = (lower - lag(lower))/lag(lower),
                   mod_rate_high = (upper - lag(upper))/lag(upper))

# convert inf to 0 #
KS.harv[38, 11] <- 0
KS.harv[43, 11] <- 0

## MI calculate harvest rate in simulation ##
MI.harv <- merge(MI.harv, Mauryear.tbl[, c(1, 5)], all.x = TRUE)
MI.harv$Harvest_rate_sim <- (MI.harv$Harvest / (MI.harv$Harvest + MI.harv$Mean))
MI.harv$high_Harvest_rate_sim <- (MI.harv$Harvest / (MI.harv$Harvest + MI.harv$lower))
MI.harv$low_Harvest_rate_sim <- (MI.harv$Harvest / (MI.harv$Harvest + MI.harv$upper))

## MI annual growth rate in simulation ##
MI.harv <- mutate(MI.harv, mod_rate_mean = (Mean - lag(Mean))/lag(Mean),
                   mod_rate_low = (lower - lag(lower))/lag(lower),
                   mod_rate_high = (upper - lag(upper))/lag(upper))

# convert inf to 0 #
MI.harv[27, 11] <- 0
```

### Plots of model runs and survey model
```{r model plots}
## Colors ##
cols1 <- c("HARV" = "#000000", "NOHARV" = "#000000", "MOD" = "#F04546")

## Labels ##
ylabSO <- ylab("Sea otters \n (+/- 95% CI)")
xlabYR <- xlab("Year") 
ylabMHR <- ylab("Rate")

## All Southeat Harvest and no harvest ## 
AHNH <- ggplot() +
  geom_line(data = SE.runs, aes(Year, Mean_noharv), col = cols1[2], lty = 2) +
  geom_line(data = SE.runs, aes(Year, high_noharv), col = cols1[2], size = 0.25, lty = 2) +
  geom_line(data = SE.runs, aes(Year, low_noharv), col = cols1[2], size = 0.25, lty = 2) +
  geom_line(data = SE.runs, aes(Year, Mean_harv), col = cols1[1]) +
  geom_ribbon(data = SE.runs, aes(Year, ymin = low_harv, ymax = high_harv), alpha = 0.2) +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(0,50000), breaks = c(0, 10000, 20000, 30000, 40000, 50000)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("") +
  ylabSO

## All Southeast Harvest and survey ##
AHS <- ggplot() +
  geom_line(data = SE.runs, aes(Year, Mean_harv), col = cols1[1], lty = 2) +
  geom_line(data = SE.runs, aes(Year, low_harv), col = cols1[1], size = 0.25, lty = 2) +
  geom_line(data = SE.runs, aes(Year, high_harv), col = cols1[1], size = 0.25, lty = 2) +
  geom_line(data = survey.mod, aes(Year, Mean),  col = "red") +
  geom_ribbon(data = survey.mod, aes(Year, ymin = CI_LO, ymax = CI_HI), fill = "red", alpha = 0.3) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010)) +
  scale_y_continuous(limits = c(0,42000), breaks = c(0, 10000, 20000, 30000, 40000)) +
  labs(x = "", y = expression(atop("Sea otters", paste("  (+/- 95% CI)")))) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## All Southeast simulation harvet and growth rate ##
ASHR <- ggplot(data = SE.runs) +
  geom_line(aes(Year, Harvest_rate_sim), col = "red") +
  #geom_ribbon(aes(Year, ymin = low_Harvest_rate_sim, ymax = high_Harvest_rate_sim), alpha = 0.3, fill = "red") +
  geom_line(aes(Year, mod_rate_mean)) +
  #geom_ribbon(aes(Year, ymin = mod_rate_low, ymax = mod_rate_high), alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = c(-0.2, -0.1, 0, 0.1, 0.2), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlabYR +
  ylabMHR

## Sitka harvest and no harvest ##
SHNH <- ggplot() +
  geom_line(data = SS.harv, aes(Year, Mean),  col = "black") +
  geom_ribbon(data = SS.harv, aes(Year, ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line(data = SS.noharv, aes(Year, Mean),  col = "black", lty = 2) +
  geom_line(data = SS.noharv, aes(Year, lower), size = 0.25, lty = 2) +
  geom_line(data = SS.noharv, aes(Year, upper), size = 0.25, lty = 2) +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(0, 2000), breaks = c(0, 500, 1000, 1500, 2000)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka harvest and survey ##
SHS <- ggplot() +
  geom_line(data = SS.harv, aes(Year, Mean),  col = "black", lty = 2) +
  geom_line(data = SS.harv, aes(Year, upper), size = 0.25, col = "black", lty = 2) +
  geom_line(data = SS.harv, aes(Year, lower), size = 0.25, col = "black", lty = 2) +
  geom_line(data = SS.survey, aes(Year, Mean),  col = "red") +
  geom_ribbon(data = SS.survey, aes(Year, ymin = CI_LO, ymax = CI_HI), fill = "red", alpha = 0.3) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010)) +
  scale_y_continuous(limits = c(0, 4000), breaks = c(0, 1000, 2000, 3000, 4000)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Sitka simulation harvet and growth rate ##
SSHR <- ggplot(data = SS.harv) +
  geom_line(aes(Year, Harvest_rate_sim), col = "red") +
  #geom_ribbon(aes(Year, ymin = low_Harvest_rate_sim, ymax = high_Harvest_rate_sim), alpha = 0.3, fill = "red") +
  geom_line(aes(Year, mod_rate_mean)) +
  #geom_ribbon(aes(Year, ymin = mod_rate_low, ymax = mod_rate_high), alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-0.6, 0.6), breaks = c(-0.6, -0.3, 0, 0.3, 0.6), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("") +
  xlabYR

## Keku harvest and no harvest ##
KHNH <- ggplot() +
  geom_line(data = KS.harv, aes(Year, Mean),  col = "black") +
  geom_ribbon(data = KS.harv, aes(Year, ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line(data = KS.noharv, aes(Year, Mean),  col = "black", lty = 2) +
  geom_line(data = KS.noharv, aes(Year, lower), size = 0.25, lty = 2) +
  geom_line(data = KS.noharv, aes(Year, upper), size = 0.25, lty = 2) +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(0, 3000), breaks = c(0, 1000 ,2000, 3000)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Keku harvest and survey ##
KHS <- ggplot() +
  geom_line(data = KS.harv, aes(Year, Mean),  col = "black", lty = 2) +
  geom_line(data = KS.harv, aes(Year, upper), size = 0.25, col = "black", lty = 2) +
  geom_line(data = KS.harv, aes(Year, lower), size = 0.25, col = "black", lty = 2) +
  geom_line(data = KS.survey, aes(Year, Mean),  col = "red") +
  geom_ribbon(data = KS.survey, aes(Year, ymin = CI_LO, ymax = CI_HI), fill = "red", alpha = 0.3) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010)) +
  scale_y_continuous(limits = c(0,1500), breaks = c(0, 500, 1000, 1500)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Keku simulation harvet and growth rate ##
KSHR <- ggplot(data = subset(KS.harv, Year > 1999)) +
  geom_line(aes(Year, Harvest_rate_sim), col = "red") +
  #geom_ribbon(aes(Year, ymin = low_Harvest_rate_sim, ymax = high_Harvest_rate_sim), alpha = 0.3, fill = "red") +
  geom_line(aes(Year, mod_rate_mean)) +
  #geom_ribbon(aes(Year, ymin = mod_rate_low, ymax = mod_rate_high), alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-1, 1), breaks = c(-1, -0.5, 0, 0.5, 1), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("") +
  xlabYR

## Maurelle harvest and no harvest ##
MHNH <- ggplot() +
  geom_line(data = MI.harv, aes(Year, Mean),  col = "black") +
  geom_ribbon(data = MI.harv, aes(Year, ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line(data = MI.noharv, aes(Year, Mean),  col = "black", lty = 2) +
  geom_line(data = MI.noharv, aes(Year, lower), size = 0.25, lty = 2) +
  geom_line(data = MI.noharv, aes(Year, upper), size = 0.25, lty = 2) +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(0,6000), breaks = c(0, 2000, 4000, 6000)) +
  labs(x = "", y = "") +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle harvest and survey ##
MHS <- ggplot() +
  geom_line(data = MI.harv, aes(Year, Mean), col = "black", lty = 2) +
  geom_line(data = MI.harv, aes(Year, upper), size = 0.25, col = "black", lty = 2) +
  geom_line(data = MI.harv, aes(Year, lower), size = 0.25, col = "black", lty = 2) +
  geom_line(data = MI.survey, aes(Year, Mean), col = "red") +
  geom_ribbon(data = MI.survey, aes(Year, ymin = CI_LO, ymax = CI_HI), fill = "red", alpha = 0.3) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010)) +
  scale_y_continuous(limits = c(0,8000), breaks = c(0, 2000, 4000, 6000, 8000)) +
  labs(x = "Year", y = expression(atop("Sea otters", paste("  +/- 95% CI")))) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1))

## Maurelle simulation harvet rate ##
MSHR <- ggplot(data = MI.harv) +
  geom_line(aes(Year, Harvest_rate_sim), col = "red") +
  #geom_ribbon(aes(Year, ymin = low_Harvest_rate_sim, ymax = high_Harvest_rate_sim), alpha = 0.3, fill = "red") +
  geom_line(aes(Year, mod_rate_mean)) +
  #geom_ribbon(aes(Year, ymin = mod_rate_low, ymax = mod_rate_high), alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-0.2, 0.2), breaks = c(-0.2, -0.1, 0, 0.1, 0.2), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12), axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("") +
  xlabYR
```

## Calculating Harvest Effect
To be run after running both modes of the simulation, with harvest and without harvest.

### Calculate Difference in N sea otters by block by Year
```{r N diff}
## All Southeast ##
Nyrs <- 46
Years <- c(1970:2015)

# Proportional difference #
Lo <- numeric(length = Nyrs)
Hi <- numeric(length = Nyrs)
means <- numeric(length = Nyrs)
Lo_prop <- numeric(length = Nyrs)
Hi_prop <- numeric(length = Nyrs)
means_prop <- numeric(length = Nyrs)
for(y in 1:46){
  iii <- which(RepSums_SEAK_harv[,y] >= 10 & RepSums_SEAK_noharv[,y] >= 10)
  if (length(iii) > 5){
    SEAK_diff <- RepSums_SEAK_harv[iii,y] - RepSums_SEAK_noharv[iii,y]
    SEAK_diff_prop <- SEAK_diff/mean(RepSums_SEAK_noharv[iii,y])
    dens <- density(SEAK_diff, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo[y] <- as.numeric(CI[1])
    Hi[y] <- as.numeric(CI[2])
    means[y] <- mean(Keku_diff)
    dens <- density(SEAK_diff_prop, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo_prop[y] <- as.numeric(CI[1])
    Hi_prop[y] <- as.numeric(CI[2])
    means_prop[y] <- mean(SEAK_diff_prop)
  }
}

SEAK_diff_full <- data.frame(Year = Years, Mean = means, lower = Lo, upper = Hi, Mean_prop = means_prop, lower_prop = Lo_prop, upper_prop = Hi_prop)

## Sitka Sound ##
Nyrs <- 46
Years <- c(1970:2015)

# Proportional difference #
Lo <- numeric(length = Nyrs)
Hi <- numeric(length = Nyrs)
means <- numeric(length = Nyrs)
Lo_prop <- numeric(length = Nyrs)
Hi_prop <- numeric(length = Nyrs)
means_prop <- numeric(length = Nyrs)
for(y in 1:46){
  iii <- which(RepSums_Sitka_harv[,y] >= 10 & RepSums_Sitka_noharv[,y] >= 10)
  if (length(iii) > 5){
    Sitka_diff <- RepSums_Sitka_harv[iii,y] - RepSums_Sitka_noharv[iii,y]
    Sitka_diff_prop <- Sitka_diff/mean(RepSums_Sitka_noharv[iii,y])
    dens <- density(Sitka_diff, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo[y] <- as.numeric(CI[1])
    Hi[y] <- as.numeric(CI[2])
    means[y] <- mean(Keku_diff)
    dens <- density(Sitka_diff_prop, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo_prop[y] <- as.numeric(CI[1])
    Hi_prop[y] <- as.numeric(CI[2])
    means_prop[y] <- mean(Sitka_diff_prop)
  }
}

Sitka_diff_full <- data.frame(Year = Years, Mean = means, lower = Lo, upper = Hi, Mean_prop = means_prop, lower_prop = Lo_prop, upper_prop = Hi_prop)

## Keku Strait ##
Nyrs <- 17
Years <- c(2000:2015)

# Proportional difference #
Lo <- numeric(length = Nyrs)
Hi <- numeric(length = Nyrs)
means <- numeric(length = Nyrs)
Lo_prop <- numeric(length = Nyrs)
Hi_prop <- numeric(length = Nyrs)
means_prop <- numeric(length = Nyrs)
for(y in 31:47){
  iii <- which(RepSums_Keku_harv[,y] >= 10 & RepSums_Keku_noharv[,y] >= 10)
  if (length(iii) > 5){
    Keku_diff <- RepSums_Keku_harv[iii,y] - RepSums_Keku_noharv[iii,y]
    Keku_diff_prop <- Keku_diff/mean(RepSums_Keku_noharv[iii,y])
    dens <- density(Keku_diff, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo[y] <- as.numeric(CI[1])
    Hi[y] <- as.numeric(CI[2])
    means[y] <- mean(Keku_diff)
    dens <- density(Keku_diff_prop, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo_prop[y] <- as.numeric(CI[1])
    Hi_prop[y] <- as.numeric(CI[2])
    means_prop[y] <- mean(Keku_diff_prop)
  }
}

Keku_diff_full <- data.frame(Year = Years, Mean = means[32:47], lower = Lo[32:47], upper = Hi[32:47], Mean_prop = means_prop[32:47], lower_prop = Lo_prop[32:47], upper_prop = Hi_prop[32:47])

## Maurelle Islands ##
Nyrs <- 46
Years <- c(1970:2015)

# Proportional difference #
Lo <- numeric(length = Nyrs)
Hi <- numeric(length = Nyrs)
means <- numeric(length = Nyrs)
Lo_prop <- numeric(length = Nyrs)
Hi_prop <- numeric(length = Nyrs)
means_prop <- numeric(length = Nyrs)
for(y in 1:46){
  iii <- which(RepSums_Maurelle_harv[,y] >= 10 & RepSums_Maurelle_noharv[,y] >= 10)
  if (length(iii) > 5){
    Maurelle_diff <- RepSums_Maurelle_harv[iii,y] - RepSums_Maurelle_noharv[iii,y]
    Maurelle_diff_prop <- Maurelle_diff/mean(RepSums_Maurelle_noharv[iii,y])
    dens <- density(Maurelle_diff, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo[y] <- as.numeric(CI[1])
    Hi[y] <- as.numeric(CI[2])
    means[y] <- mean(Keku_diff)
    dens <- density(Maurelle_diff_prop, adjust = 7)
    CI <- quantile(dens, probs = c(.05, .95))
    Lo_prop[y] <- as.numeric(CI[1])
    Hi_prop[y] <- as.numeric(CI[2])
    means_prop[y] <- mean(Maurelle_diff_prop)
  }
}

Maurelle_diff_full <- data.frame(Year = Years, Mean = means, lower = Lo, upper = Hi, Mean_prop = means_prop, lower_prop = Lo_prop, upper_prop = Hi_prop)
```

### Plotting harvest effect
```{r diff plots}
## Labels ##
ylabPD <- ylab(expression(atop("Proportion difference", paste("(+/- 95% CI)"))))

## All SEAK ##
AND <- ggplot(SEAK_diff_full) +
  geom_line(aes(Year, Mean_prop)) +
  geom_ribbon(aes(Year, ymin = lower_prop, ymax  = upper_prop), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Year") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-0.3, 0.3), breaks = c(-0.3, -0.15, 0.0, 0.15, 0.3), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Proportion difference \n (+/- 95% CI)")

SND <- ggplot(Sitka_diff_full) +
  geom_line(aes(Year, Mean_prop)) +
  geom_ribbon(aes(Year, ymin = lower_prop, ymax  = upper_prop), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-1.00, 1.00), breaks = c(-1.0, -0.50, 0.00, 0.50, 1.0), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

KND <- ggplot(Keku_diff_full) +
  geom_line(aes(Year, Mean_prop)) +
  geom_ribbon(aes(Year, ymin = lower_prop, ymax  = upper_prop), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-3, 3), breaks = c(-3, -1.5, 0.0, 1.5, 3), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))

MND <- ggplot(Maurelle_diff_full) +
  geom_line(aes(Year, Mean_prop)) +
  geom_ribbon(aes(Year, ymin = lower_prop, ymax  = upper_prop), alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Year", y = "") +
  scale_x_continuous(limits = c(1988, 2015), breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  scale_y_continuous(limits = c(-0.5, 0.5), breaks = c(-0.5, -0.25, 0.0, 0.25, 0.5), labels = scales::number_format(accuracy = 0.01)) +
  theme(text = element_text(size = 12, color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
```

## Panel 2
Panel figure of model comparisons
```{r panel 2}
theme_set(theme_cowplot(font_size = 10))
xoff <- .40 # relative x position of label, within one plot
yoff <- .93 # relative y position of label, within one plot
plot_grid(AHNH, SHNH, KHNH, MHNH, AND, SND, KND, MND, nrow = 2, ncol = 4, align = "hv") +
  draw_plot_label(label = c("a", "b", "c", "d", "e", "f", "g", "h"), x = rep((xoff + 0:3) / 4, 2), y = 1-(1-yoff+rep(0:1, each = 4)) / 2, hjust = .5, vjust = .5, size = 12)
```

## Panel X
Panel of havest model to survey
```{r panel 3}
theme_set(theme_cowplot(font_size = 12))
plot_grid(AHS, SHS, KHS, MHS, nrow = 4, ncol = 1, labels = "auto", hjust = 0.08, label_size = 12)
```


## Sea otter harvest by hunt origin
Analysis of harvest data grouped by listed hunt origin
```{r harv hunt orig}
## Long Hunt origin ##
hunt.tbl <- as.data.frame(
  harv %>% 
    group_by(Year, Hunt.Orig.Name) %>% 
    summarise(Harvest=n())
)

## Simplified Hunt Origin ##
huntsimp.tbl <-
```

Plots of harvest by hunt origin
```{r harv hunt orig plots}
## barplot of harvest by Hunt.Orig.Name ##
hunt.tbl <- arrange(hunt.tbl,desc(Harvest))
par(mar=c(9,4,4,2))
barplot(hunt.tbl$Harvest,ylim=c(0,4000),ylab="Harvest",col=0,names.arg=hunt.tbl$Hunt.Orig.Name,las=2)
mtext("Hunt Origin",side=1,line=7)


## dot chart of hunt origin ##
ggplot(hunt.tbl) +
  geom_point(aes(Year, Hunt.Orig.Name, size = Harvest)) +
  scale_x_continuous(breaks = c(1990, 1995, 2000, 2005, 2010, 2015)) +
  ylab("Hunt Origin") +
  scale_y_discrete(limits = rev(levels(hunt.tbl$Hunt.Orig.Name))) +
  theme(text = element_text(size = 12))
```

## Sea otter harvest by % native, # hunters, occupation
```{r harv by dur}
## Build data ##
hunter.loc.subreg.cum <- merge(hunter.loc.year, hunt.subreg, by = "Village", all.x = TRUE)
cumharv.hunt <- merge(cumharv, hunter.loc.subreg.cum [,1:3], by.x = "subreg", by.y = "Subregion", all.x = TRUE)

# Deal with s02 #
cumharv.hunt <- filter(cumharv.hunt, subreg != "S02")
cumharv.hunt <- rbind(cumharv.hunt, c("S02", 45, 42.1, 1880, "Craig, Klawock, Naukati Bay, Edna Bay", 223))

# Deal with s03 #
cumharv.hunt <- filter(cumharv.hunt, subreg != "S03")
cumharv.hunt <- rbind(cumharv.hunt, c("S03", 21, 42.12, 854, "Craig, Klawock", 215))

# remove NA #
cumharv.hunt[is.na(cumharv.hunt)] <- 0

# convert to numeric #
cumharv.hunt$n_hunter <- as.numeric(cumharv.hunt$n_hunter)
cumharv.hunt$percent_AKnative <- as.numeric(cumharv.hunt$percent_AKnative)
cumharv.hunt$prop_AKnative <- cumharv.hunt$percent_AKnative / 100
cumharv.hunt$years_occ <- as.numeric(cumharv.hunt$years_occ)
cumharv.hunt$cummulative_harvest <- as.numeric(cumharv.hunt$cummulative_harvest)

## Calculate mean harvest rate by block ##
# prep #
subpops <- unique(survey.mod.reg$Subregion)
rate.sub <- data.frame(Year = rep(1970:2012, 21), Subpop = rep(subpops, 43))

harv.sub <- harv %>% 
  group_by(Subpop, Year) %>% 
  summarize(harv.otts = n())

rate.sub <- merge(rate.sub, survey.mod.reg, by.x = c("Year", "Subpop"), by.y = c("Year", "Subregion"), all.x = TRUE)
rate.sub <- merge(rate.sub, harv.sub, by = c("Year", "Subpop"), all.x = TRUE)

rate.sub <- rate.sub[, c(1,2,7,15)]
colnames(rate.sub) <- c("Year", "Subpop", "Survey", "Harvest")

rate.sub[is.na(rate.sub)] <- 0

rate.sub$Harvest.rate <- rate.sub$Harvest / (rate.sub$Survey + rate.sub$Harvest)

# actual mean calc #
harv.sub.mean <- rate.sub %>%
  filter(Year > 1987) %>% 
  group_by(Subpop) %>% 
  summarise(mean.harv = mean(Harvest.rate, na.rm = TRUE))

# merge to cumharv.hunt #
subreg.dat <- merge(cumharv.hunt, harv.sub.mean, by.x = "subreg", by.y = "Subpop", all.x = TRUE)
subreg.dat[is.na(subreg.dat)] <- 0

# Append prop K data #
subreg.dat <- merge(subreg.dat, block.data[,c(3,14, 15)], by.x = "subreg", by.y = "Subpop", all.x = TRUE)

# add n villages #
subreg.dat$Village
subreg.dat$n_Village <- c(0,0,0,1,0,0,1,0,1,1,0,0,0,1,0,1,0,4,2,0,0,1,0,1,0,0,0,0,0,1,1)
```

## Regression of Sea otter harvest rate by % native, # hunters, occupation 
We will run a regression of harvest rate as a funciton of population density, years of sea otter occupation, population effect (population scaled by distance), and hunter effect (scaled by distance). These data will be summarized from 1990 to 2010. Unknown hunter identity will be removed from analysis.
### Data Prep
```{r}
## Build by year data ##
subpops <- unique(survey.mod.reg$Subregion)
d <- data.frame(Year = c(rep(1990, 21), rep(1991, 21), rep(1992, 21), rep(1993, 21), rep(1994, 21), rep(1995, 21), rep(1996, 21), rep(1997, 21), rep(1998, 21), rep(1999, 21), rep(2000, 21), rep(2001, 21), rep(2002, 21), rep(2003, 21), rep(2004, 21), rep(2005, 21), rep(2005, 21), rep(2007, 21), rep(2008, 21), rep(2009, 21), rep(2010, 21)), Subregion = rep(subpops, 21)) 

d <- merge(d, cumharv[,1:2], by.x = "Subregion", by.y = "subreg", all.x = TRUE) # add raw occupation years

# Deal with occupation years #
d$years_occ <- d$years_occ - 3
d$years_occ_tru <- d$years_occ - (2012 - d$Year)
d$years_occ_tru <- ifelse(d$years_occ_tru < 0, 0, d$years_occ_tru)

# Calculate annual density by subregion #
survey.mod.reg <- merge(survey.mod.reg, block.data[,c(3, 9)], by.x = "Subregion", by.y = "Subpop", all.x = TRUE)
survey.mod.reg$pop_dens <- survey.mod.reg$Mean / survey.mod.reg$Area_km
d <- merge(d, survey.mod.reg[,c(1, 3, 7, 16)], by = c("Year", "Subregion"), all.x = TRUE)

# Calculate Distnace effect #
inv.dist.yr <- data.frame(Subregion = rep(inv.dist$Var1, 21), Village = rep(inv.dist$Var2, 21), Value = rep(inv.dist$value, 21))

inv.dist.yr$Year <- c(rep(1990, 935), rep(1991, 935), rep(1992, 935), rep(1993, 935), rep(1994, 935), rep(1995, 935), rep(1996, 935), rep(1997, 935), rep(1998, 935), rep(1999, 935), rep(2000, 935), rep(2001, 935), rep(2002, 935), rep(2003, 935), rep(2004, 935), rep(2005, 935), rep(2005, 935), rep(2007, 935), rep(2008, 935), rep(2009, 935), rep(2010, 935))

inv.dist.yr <- merge(inv.dist.yr, cens[, c(2,4,5)], by.x = c("Village", "Year"), by.y = c("com", "Year"), all.x = TRUE) #pop
inv.dist.yr <- merge(inv.dist.yr, hunter.loc.year.tbl, by = c("Village", "Year"), all.x = TRUE) # hunters
inv.dist.yr$n_hunter[is.na(inv.dist.yr$n_hunter)] <- 0 # turn NA hunters into zeros

dis.eff <- inv.dist.yr %>% 
  group_by(Year, Subregion) %>% 
  summarise(PopEff = sum(Value * log(n)),
            HuntEff = sum(Value * n_hunter))

# Merge effect data #
d <- merge(d, dis.eff, by = c("Year", "Subregion"), all.x = TRUE)

# Remove gby and s06 #
d <- filter(d, Subregion != "GBY")

# Calculate harvest rate #
harv.sub <- harv %>% 
  group_by(Subpop, Year) %>% 
  summarize(harv.otts = n())

d <- merge(d, harv.sub, by.x = c("Year", "Subregion"), by.y = c("Year", "Subpop"), all.x = TRUE)
d$harv.otts[is.na(d$harv.otts)] <- 0 # harvested otters
d$harv_rate <- d$harv.otts / d$Mean
d$harv_rate[is.na(d$harv_rate)] <- 0 # harvested rate
d$harv_rate <- ifelse(d$harv_rate > 1, 1, d$harv_rate)
```

### Regression
```{r}
## Addressing co-linarity and linearity ##
pairs(d[, c(4, 6:8)])

ggplot(d) +
  geom_point(aes(x = years_occ_tru, y = log(pop_dens + 1), color = Subregion))

ggplot(d) +
  geom_point(aes(x = years_occ_tru^2, y = log(pop_dens + 1), color = Subregion))

ggplot(d) +
  geom_point(aes(x = years_occ_tru, y = asin(sqrt(harv_rate)), color = Subregion)) +
  geom_smooth(aes(x = years_occ_tru, y = asin(sqrt(harv_rate))), method = "loess")

# Adding quadratic years occ #
d$years_occ_tru_q <- d$years_occ_tru^2

# Adding de-trended data #
co.mod1 <- lm(log(pop_dens + 1) ~ years_occ_tru + years_occ_tru_q, data = d)
summary(co.mod1)

d$pop_dens_dt <- residuals(co.mod1)
range(d$pop_dens_dt)
hist(log(d$PopEff))
hist(sqrt(d$HuntEff))
hist(log(d$pop_dens_dt + 1))

## Models ##
# Assessing Radom Intercept #
r1 <- lm(asin(sqrt(harv_rate)) ~ years_occ_tru + years_occ_tru_q + pop_dens_dt + log(PopEff) + sqrt(HuntEff), data = d)
summary(r1)
AIC(r1)

r2 <- lme(asin(sqrt(harv_rate)) ~ years_occ_tru + years_occ_tru_q + pop_dens_dt + log(PopEff) + sqrt(HuntEff), random = ~1| Subregion, method = "REML", data = d)
AIC(r2)

# Global #
mod1 <- lme(asin(sqrt(harv_rate)) ~ years_occ_tru + years_occ_tru_q + pop_dens_dt + log(PopEff) + sqrt(HuntEff), random = ~1| Subregion, method = "ML", data = d)
summary(mod1)

st <- stepAIC(mod1, direction = "both")

## Final ##
mod2 <- lme(asin(sqrt(harv_rate)) ~  years_occ_tru + years_occ_tru_q + pop_dens_dt + sqrt(HuntEff), random = ~1| Subregion, method = "REML", data = d)
summary(mod2)
intervals(mod2)


median(d$pop_dens_dt)
median(sqrt(d$HuntEff))

pred.dat <- data.frame(years_occ_tru = unique(d$years_occ_tru), years_occ_tru_q = unique(d$years_occ_tru_q), pop_dens_dt = rep(median(d$pop_dens_dt), 41), HuntEff = rep(median(sqrt(d$HuntEff)), 41))

pred.dat$HR <- 0.0376 + (pred.dat$years_occ_tru * 0.0087) + (pred.dat$years_occ_tru_q * -0.0002) + (pred.dat$pop_dens_dt * -0.1565) + (pred.dat$HuntEff * 2.665)

plot(pred.dat$years_occ_tru, pred.dat$HR)
```

### Examine residuals
```{r}
## Examine residuals ##
plot(mod2)
resid <- data.frame(Subregion = d$Subregion, Resid = residuals(mod2), Fitted_fixed = mod2$fitted[,1], Fitted_subregion = mod2$fitted[,2])

p.r1 <- ggplot(resid) +
  geom_point(aes(x = Fitted_fixed, y = Resid, color = Subregion)) +
  labs(x = "Fitted values (fixed effects)", y = "Residuals")

p.r2 <- ggplot(resid) +
  geom_point(aes(x = Subregion, y = Resid, color = Subregion)) +
  labs(x = "Subregion", y = "Residuals")

plot_grid(p.r1, p.r2, nrow = 2)

ggplot(d) +
  geom_point(aes(x = years_occ_tru, y = asin(sqrt(harv_rate)), color = Subregion))
```

## Panel 3
```{r}
theme_set(theme_cowplot(font_size = 10))
plot_grid(Reg.YOMH, Reg.PKMH, nrow = 2, ncol = 1, labels = c("a", "b"), align = "hv")
```


```{r}
## Mean havest rate (actual) by Occupation ##
# Harvest data #
year.subreg.tbl.dat <- as.data.frame(
  harv %>%
    group_by(Year, Subpop) %>%
    summarise(Harvest=n())
)

year.subreg.tbl <- merge(year.subreg.tbl.dat, survey.mod.reg, by.x = c("Year", "Subpop"), by.y = c("Year", "Subregion"))
year.subreg.tbl <- year.subreg.tbl[!(year.subreg.tbl$Year == 1995 & year.subreg.tbl$Subpop == "S03"),] # remove year where hunting but no pop
year.subreg.tbl$rate <- year.subreg.tbl$Harvest / year.subreg.tbl$Mean
year.subreg.tbl$rate_hi <- year.subreg.tbl$Harvest / year.subreg.tbl$CI_LO
year.subreg.tbl$rate_lo <- year.subreg.tbl$Harvest / year.subreg.tbl$CI_HI

meanrate.subreg.tbl <- data.frame(
  year.subreg.tbl %>% 
    group_by(Subpop) %>% 
    summarise(mean.rate = mean(rate),
              sd.rate = sd(rate))
)

# Merge with occupation and % native
yrocc.harvrate <- merge(cumharv, meanrate.subreg.tbl, by.x = "subreg", by.y = "Subpop")

# Plot #
ggplot(yrocc.harvrate) +
  geom_point(aes(x = years_occ, y = mean.rate), size = 4) +
  geom_errorbar(aes(x = years_occ, ymin = mean.rate - sd.rate, ymax = mean.rate + sd.rate))
```

## Panel Supplemental
```{r sup panel}
theme_set(theme_cowplot(font_size = 12))
plot_grid(CHPN, CHNH, nrow = 1, ncol = 2, labels = "auto", hjust = 0.08, label_size = 12)
```


## Annual mean harvest rate by subregion
```{r}
surv.harv.mod <- merge(survey.mod.reg, harv.sub, by.x = c("Year", "Subregion"), by.y = c("Year", "Subpop"), all.x = TRUE)
surv.harv.mod$harv.otts[is.na(surv.harv.mod$harv.otts)] <- 0
surv.harv.mod$harv.rate <- surv.harv.mod$harv.otts / (surv.harv.mod$harv.otts + surv.harv.mod$Mean)

reg.ann.harv.rate <- surv.harv.mod %>%
  filter(Year > 1987) %>% 
  group_by(Subregion) %>% 
  summarize(mean.harv.rate = mean(harv.rate, na.rm = TRUE))
```


## Summary Statistics
Basic summary stats from harvest and model output for manuscript
```{r summ stats}
Mauryear.tbl[1:13, 6] <- NA

## Mean proportion contribution to total harvest ##
mean.contrib <- data.frame(Region = c("Sitka Sound", "Keku Strait", "Maurelle Islands"),
                           Mean = c(mean(regprop.tbl$pSitka, na.rm = TRUE), mean(regprop.tbl$pKeku, na.rm = TRUE), mean(regprop.tbl$pMaur, na.rm = TRUE)),
                           SD = c(sd(regprop.tbl$pSitka, na.rm = TRUE), sd(regprop.tbl$pKeku, na.rm = TRUE), sd(regprop.tbl$pMaur, na.rm = TRUE)))

## Mean observed harvest rates ##
mean.rates <- data.frame(Region = c("Southeast Alaska", "Sitka Sound", "Keku Strait", "Maurelle Islands"),
                         Mean = c(mean(year.tbl$rate, na.rm  = TRUE), mean(Sitkayear.tbl$rate, na.rm  = TRUE), mean(Kekuyear.tbl$rate, na.rm  = TRUE), mean(Mauryear.tbl$rate, na.rm  = TRUE)),
                         SD = c(sd(year.tbl$rate, na.rm  = TRUE), sd(Sitkayear.tbl$rate, na.rm  = TRUE), sd(Kekuyear.tbl$rate, na.rm  = TRUE), sd(Mauryear.tbl$rate, na.rm  = TRUE)),
                         Min = c(min(year.tbl$rate, na.rm  = TRUE), min(Sitkayear.tbl$rate, na.rm  = TRUE), min(Kekuyear.tbl$rate, na.rm  = TRUE), min(Mauryear.tbl$rate, na.rm  = TRUE)),
                         Max = c(max(year.tbl$rate, na.rm  = TRUE), max(Sitkayear.tbl$rate, na.rm  = TRUE), max(Kekuyear.tbl$rate, na.rm  = TRUE), max(Mauryear.tbl$rate, na.rm  = TRUE)))

mean.rates[,2:5] <- round(mean.rates[,2:5] * 100, 2)

## Mean simulation harvest rates ##
mean.sim.rates <- data.frame(Region = c("Southeast Alaska", "Sitka Sound", "Keku Strait", "Maurelle Islands"),
                         Mean = c(mean(SE.runs$Harvest_rate_sim, na.rm  = TRUE), mean(SS.harv$Harvest_rate_sim, na.rm  = TRUE), mean(KS.harv$Harvest_rate_sim, na.rm  = TRUE), mean(MI.harv$Harvest_rate_sim, na.rm  = TRUE)),
                         SD = c(sd(SE.runs$Harvest_rate_sim, na.rm  = TRUE), sd(SS.harv$Harvest_rate_sim, na.rm  = TRUE), sd(KS.harv$Harvest_rate_sim, na.rm  = TRUE), sd(MI.harv$Harvest_rate_sim, na.rm  = TRUE)),
                         Min = c(min(SE.runs$Harvest_rate_sim, na.rm  = TRUE), min(SS.harv$Harvest_rate_sim, na.rm  = TRUE), min(KS.harv$Harvest_rate_sim, na.rm  = TRUE), min(MI.harv$Harvest_rate_sim, na.rm  = TRUE)),
                         Max = c(max(SE.runs$Harvest_rate_sim, na.rm  = TRUE), max(SS.harv$Harvest_rate_sim, na.rm  = TRUE), max(KS.harv$Harvest_rate_sim, na.rm  = TRUE), max(MI.harv$Harvest_rate_sim, na.rm  = TRUE)))

mean.sim.rates[,2:5] <- round(mean.sim.rates[,2:5] * 100, 2)

## Harvest rates when growth is negative ##
SE.runs %>% 
  filter(mod_rate_mean <=0) %>% 
  summarise(mean_harv_rate = mean(Harvest_rate_sim, na.rm = TRUE),
            sd_harv_rate = sd(Harvest_rate_sim, na.rm = TRUE))

SS.harv %>% 
  filter(mod_rate_mean <=0) %>% 
  summarise(mean_harv_rate = mean(Harvest_rate_sim, na.rm = TRUE),
            sd_harv_rate = sd(Harvest_rate_sim, na.rm = TRUE))

KS.harv %>% 
  filter(mod_rate_mean <=0) %>% 
  summarise(mean_harv_rate = mean(Harvest_rate_sim, na.rm = TRUE),
            sd_harv_rate = sd(Harvest_rate_sim, na.rm = TRUE))

MI.harv %>% 
  filter(mod_rate_mean <=0) %>% 
  summarise(mean_harv_rate = mean(Harvest_rate_sim, na.rm = TRUE),
            sd_harv_rate = sd(Harvest_rate_sim, na.rm = TRUE))

## Years when sim harvest rate exceeded realized growth ##
SE.runs[SE.runs$Harvest_rate_sim > SE.runs$mod_rate_mean,]
SS.harv[SS.harv$Harvest_rate_sim > SS.harv$mod_rate_mean,]
KS.harv[KS.harv$Harvest_rate_sim > KS.harv$mod_rate_mean,]
MI.harv[MI.harv$Harvest_rate_sim > MI.harv$mod_rate_mean,]
```

Harvest by year by subpopulation
```{r harv subpop all}
# Extract names #
subs <- data.frame(BlokOcc$Block_ID)

# summarise #
harvsubpop <- data.frame(
  harv %>% 
    group_by(Year, Subpop) %>% 
    summarise(Harvest = n())
)

# Clean up #
harvsubpop <- merge(subs, harvsubpop, by.x = "BlokOcc.Block_ID", by.y = "Subpop", all.x = TRUE)
harvsubpop <- spread(harvsubpop, Year, Harvest)
harvsubpop[is.na(harvsubpop)] <- 0
harvsubpop <- harvsubpop[,1:29]
colnames(harvsubpop) <- c("Subpop", as.character(1988:2015))

# export #
write.csv(harvsubpop, "All_Data/Harvest_all_subpops.csv", row.names = FALSE)
```

Harvest Stats by subpop for mapping. Originally I wanted to have mean rate and cumualtive harvest but calcuatling mean rate is weird in some some regions. What happens is that the survey model was estimating much lower number of sea otters in some places that were reposrted harvested so the rate was over 1. This highlights the current issue with spatial and temportal resoltion of sea otter surveys and hunting.  
```{r}
## Cummulative harvest ##
cumharvsubpop <- data.frame(
  harv %>% 
    group_by(Subpop) %>% 
    summarise(Harvest = n())
)

## Mean rate ##
harvsubpop <- data.frame(
  harv %>% 
    group_by(Year, Subpop) %>% 
    summarise(Harvest = n())
)

rate.tbl <- merge(survey.mod.reg, harvsubpop, by.x = c("Year", "Subregion"), by.y = c("Year", "Subpop"), all.x = TRUE)
rate.tbl$rate <- rate.tbl$Harvest/rate.tbl$Mean
rate.tbl$rate_hi <- rate.tbl$Harvest/rate.tbl$CI_LO
rate.tbl$rate_lo <- rate.tbl$Harvest/rate.tbl$CI_HI

meanrate.tbl <- data.frame(
  rate.tbl %>% 
    group_by(Subregion) %>% 
    summarise(mean_rate = mean(rate, rm.na = TRUE))
)
```